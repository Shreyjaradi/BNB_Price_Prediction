---
title: "BNB-Price-Prediction-Project"
author: "Shrey Jaradi"
date: "2022-11-23"
output: html_document
---

```{r}
library(dplyr)
library(tidyverse)
library(ggplot2)
library(psych)
library(ggmap)
library(GGally)
library(caret)
library(glmnet)
```


```{r}
bnb_df = read.csv(file='../data/AB_NYC_2019.csv') 
head(bnb_df)
```
```{r}
dim(bnb_df)
```
```{r}
summary.default(bnb_df)
```

**name :** Name of the Place 
**host_name :** It's a host name - name of owner  - not much important          
**neighbourhood_group :** This also we can convert to dummy variable -as this is also important- there are certain negihbourhood where price is varies  
**neighbourhood :** There are so many values if we create dummy variable for this, it's gonna create so much feature better to ignore this column            
**Room Type :**  we can convert to Dummy variable as there are three Room Type and it will help us as this is much relevant column 
**last_review  :** This is date column we can convert it to datetime column. 

```{r}
cat("Room Type : ", unique(bnb_df$room_type))
cat("\nNeighbourhood group : ",unique(bnb_df$neighbourhood_group))
```


There are 1052 missing values in "reviews_per_month" and "last_review" column,
as this are the column for datetime and number of reviews  last_review, 
we can replace it with NA for last_review and 0 for reviews_per_month.

```{r}
naniar::gg_miss_var(bnb_df) +
  theme_minimal()+
  labs(y = "Look at all the Missing Values") 
```


```{r}
bnb_df['last_review'][is.na(bnb_df['last_review'])] = 'NA'
bnb_df['reviews_per_month'][is.na(bnb_df['reviews_per_month'])] = 0
bnb_df = bnb_df[(bnb_df$price!=0),]
```

```{r}
naniar::gg_miss_var(bnb_df) +
  theme_minimal()+
  labs(y = "Look at all the Missing Values") 
```

 
 
Let's try to understand the statistics by Room Type , As we are trying to predict price , Let's check what are the minimum, maximum, average price according to room type and neighbourhood group

Manhattan is costliest area, their average price is almoot $250.
```{r}
options(dplyr.summarise.inform = FALSE)
bnb_df %>% group_by(room_type, neighbourhood_group) %>% dplyr::summarise(min_price = min(price), avg_price = mean(price),max_price = max(price))
```


Price in Neighbourhood_group by room Type 

```{r}
ggplot(bnb_df, aes(x = neighbourhood_group, y = price, fill = room_type)) +
  geom_bar(position = "dodge", stat = "identity") +
  theme_classic() +
  labs(title = "NYC Airbnb Neighbourhood vs Price", x = "Neighbourhood", y = "Price") +
  theme(plot.title = element_text(face = "bold"))
```

Costliest Neighbourhood 
```{r}
grp_neighbourhood_df = bnb_df %>% 
  group_by(neighbourhood_group, price) %>% 
  tally(sort = TRUE) %>% 
  filter(row_number() <= 5)
ggplot(data = grp_neighbourhood_df, aes(x = neighbourhood_group, y = price)) +
  geom_col() 
```


```{r}
grpbynhood_df = bnb_df %>% 
  group_by(neighbourhood, price) %>% 
  tally(sort = TRUE) %>% 
  filter(row_number() <= 5)

ggplot(data = grpbynhood_df, aes(x = neighbourhood, y = price)) +
  geom_col() 
```



Import NYC Map and show datapoint , according to price, which are costly neighboorhood and preferrred one
```{r}

```


Do more Visualisation if possible ! - and find out some insights about our data
```{r}

```


Need to convert the categorical data to level 
```{r}
bnb_df$neighbourhood = as.factor(bnb_df$neighbourhood)
bnb_df$neighbourhood_group = as.factor(bnb_df$neighbourhood_group)
bnb_df$room_type = as.factor(bnb_df$room_type)
bnb_df$last_review = as.POSIXct(bnb_df$last_review, format="%Y-%m-%d", tz="UTC")

```

```{r}
summary.default(bnb_df)
```

```{r}
head(bnb_df)
```

Filter the Categorical Columns, to get the correlation of matrix
```{r}
filter_cat_bnb_df = bnb_df [,c("id","host_id","neighbourhood_group","neighbourhood", "latitude", "longitude", "room_type", "price", "minimum_nights", "number_of_reviews" ,"last_review", "reviews_per_month", "calculated_host_listings_count","availability_365")] 
```



```{r}
corr_bnb_df =  bnb_df [,c("neighbourhood_group", "room_type", "price", "minimum_nights", "number_of_reviews" ,"reviews_per_month", "calculated_host_listings_count","availability_365")] 
corr_bnb_df = corr_bnb_df[, sapply(corr_bnb_df, is.numeric)]
corr_bnb_df = corr_bnb_df[complete.cases(corr_bnb_df),]
```

```{r}
pairs.panels(corr_bnb_df, method = "pearson", hist.col = "#00AFBB",density = TRUE,ellipses = TRUE)
```

Machine Learning - Linear Regression

-Data Split
```{r}
bnb_df_index = createDataPartition(filter_cat_bnb_df$price, p =.70,list=FALSE)
bnb_df_train =  filter_cat_bnb_df[bnb_df_index,] 
bnb_df_test =   filter_cat_bnb_df[-bnb_df_index,] 
```


Excluding Features Reasons : 

- id: not relevant because it's unique number
- name: not relevant because it's  Identifier
- host_id: not relevant because it's unique number 
- host_name: not relevant because it's  Identifier
- neighbourhood: as we already take neighbourhood_group in our study, it's a redudant feature
- last_review: datetime variable, unnecessarily will complicate our model

```{r}
bnb_model = lm(price ~  neighbourhood_group + scale(latitude) +  scale(longitude) + room_type+ minimum_nights + number_of_reviews + reviews_per_month + calculated_host_listings_count + availability_365 , data=bnb_df_train)
summary(bnb_model)

```

The $R^2$ values is two low for this model, we can transform our Price feature and 
```{r}
par(mfrow=c(2,2))
plot(bnb_model)
```

Doing the Logarithmic Transformation on Y(Price) Predicted feature and 
Scaling the Latitude and Longitude Variable, 
```{r}
bnb_model_two = lm(log(price) ~  neighbourhood_group + scale(latitude)+  scale(longitude) + room_type+ minimum_nights + number_of_reviews + reviews_per_month + calculated_host_listings_count + availability_365 , data=bnb_df_train)
summary(bnb_model_two)
```


The 2nd model Q-Q plot, is much better than the previous model. We can clearly see that, and if you see the $R^2$ values also seems to be better than our previous model.

```{r}
par(mfrow=c(2,2))
plot(bnb_model_two)
```


```{r}
predicted_val = predict(bnb_model_two, bnb_df_test[,-8])
predicted_val = exp(predicted_val)
```



```{r}
RMSE_regression = sqrt(mean( (bnb_df_test$price - predicted_val)**2 ))
SSE = sum((bnb_df_test$price - predicted_val)**2)
SSR = sum((predicted_val - mean(bnb_df_test$price)) ** 2)
R2 = 1 - SSE/(SSE + SSR)
RMSE_regression
SSE
SSR
R2
```

Ridge Regression 

```{r}
x_bnb_df = data.matrix(bnb_df_train[, c("neighbourhood_group", "room_type", "price", "minimum_nights", "number_of_reviews" ,"reviews_per_month", "calculated_host_listings_count","availability_365")])
y_bnb_df = bnb_df_train$price
```

```{r}
ridge_model = glmnet(x_bnb_df, y_bnb_df, alpha=0)
ridge_summary_model = summary(ridge_model)
```

```{r}
ridge_cv_model = cv.glmnet(x_bnb_df, y_bnb_df, alpha=0)
ridge_lambda_val = ridge_cv_model$lambda.min
ridge_lambda_val
```

```{r}
plot(ridge_cv_model)
```

```{r}
ridge_best_model = glmnet(x_bnb_df, y_bnb_df, alpha=0, lambda = ridge_lambda_val)
coef(ridge_best_model)
```

```{r}
plot(ridge_model,xvar='lambda')
```
The $R^2$ is -0.36%, that is best model
```{r}
test_ridge_data_x = data.matrix(bnb_df_test[,c("neighbourhood_group", "room_type", "minimum_nights", "number_of_reviews", "price" ,"reviews_per_month", "calculated_host_listings_count","availability_365")])
y_ridge_predicted = predict(ridge_model, s = ridge_lambda_val, newx = test_ridge_data_x)
```

```{r}
reg_sst = sum((bnb_df_test$price - mean(bnb_df_test$price))^2)
reg_sst
reg_sse = sum((y_ridge_predicted - bnb_df_test$price)^2)
reg_sse
reg_rsq = 1 - reg_sse/reg_sst
reg_rsq
```


Lasso Regression 
```{r}
lasso_cv_model = cv.glmnet(x_bnb_df, y_bnb_df, alpha=1)
lasso_lambda_val = lasso_cv_model$lambda.min
lasso_lambda_val
```

```{r}
plot(lasso_cv_model)
```

```{r}
lasso_best_model = glmnet(x_bnb_df, y_bnb_df, alpha=1, lambda = lasso_lambda_val)
coef(lasso_best_model)
```


The $R^2$ is -0.37%, that is best model
```{r}
test_lasso_data_x = data.matrix(bnb_df_test[,c("neighbourhood_group", "room_type", "minimum_nights", "number_of_reviews" ,"reviews_per_month","price", "calculated_host_listings_count","availability_365")])
predict_lass_val = predict(lasso_best_model, s = lasso_lambda_val, newx = test_lasso_data_x)
```

```{r}
lasso_sst = sum((bnb_df_test$price - mean(bnb_df_test$price))^2)
lasso_sse = sum((predict_lass_val - bnb_df_test$price)^2)
lass_rsq = 1 - lasso_sse/lasso_sst
lass_rsq
```




